// File: index.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Research Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    typography: {
                        DEFAULT: {
                            css: {
                                maxWidth: 'none',
                            },
                        },
                    },
                },
            },
        }
    </script>
    <!-- Add Tailwind Typography Plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Company Research Tool</h1>
        
        <!-- Input Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <form id="researchForm" class="space-y-4">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700">Company Name</label>
                    <input type="text" id="companyName" name="companyName" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700">Location (Optional)</label>
                    <input type="text" id="location" name="location"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <button type="submit" 
                        class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Generate Report
                    </button>
                </div>
            </form>
        </div>

        <!-- Status Updates -->
        <div id="status" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
            <div class="flex">
                <div class="ml-3">
                    <p class="text-sm text-yellow-700" id="statusText">
                        Processing...
                    </p>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Research Report</h2>
                <div id="markdownOutput" class="prose prose-slate max-w-none"></div>
                <div id="rawMarkdown" class="hidden"></div>
                <button onclick="copyToClipboard()" 
                    class="mt-4 inline-flex justify-center rounded-md border border-transparent bg-green-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Copy to Clipboard
                </button>
            </div>
        </div>
    </div>

    <script>
        const PERPLEXITY_QUERIES = [
            "what is {company}",
            "{company}: recent news",
            "{company}: product, business model",
            "{company}: industry position, financials",
            "{company}: history, recent achievements",
            "{company}: mission, values",
            "{company}: culture, workplace environment",
            "{company}: culture, workplace environment; as reported by current employees",
            "What does it take to succeed at {company}?"
        ];

        async function queryPerplexity(query) {
            console.log('Starting Perplexity query:', query);

            const response = await fetch('http://localhost:5001/api/perplexity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'sonar',
                    messages: [
                        { 
                            role: 'system',
                            content: '' // This used to say "Be precise and concise."
                        },
                        { 
                            role: 'user',
                            content: query 
                        }
                    ],
                    temperature: 0.2,
                    top_p: 0.9,
                    max_tokens: 1024,
                    return_images: false,
                    return_related_questions: false,
                    stream: false,
                    presence_penalty: 0,
                    frequency_penalty: 1
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Perplexity API error: ${response.status} - ${JSON.stringify(errorData)}`);
            }

            const data = await response.json();
            console.log('Perplexity API Response:', data);

            const citations = data.citations
            const content = data.choices[0].message.content;

            const citationText = citations.map((link, index) => `[${index + 1}] ${link}`).join('\n');
            const perplexityText = citations.length > 0 ? `${content}\n\n${citationText}` : content;
            console.log('Perplexity Text:', perplexityText);

            return perplexityText;
        }

        async function queryAnthropic(markdown) {
            const requestBody = {
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 8192,
                temperature: 1,
                messages: [
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: `Produce a report based on the following information. Format in markdown with headers and lists. The purpose is to provide context for future conversations about preparing job application materials.\n\n${markdown}`
                            }
                        ]
                    }
                ]
            };
            
            const response = await fetch('http://localhost:5001/api/anthropic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Anthropic API error: ${response.status} - ${JSON.stringify(errorData)}`);
            }

            const anthropicData = await response.json();
            console.log('Anthropic API Response:', anthropicData);

            const messageContent = anthropicData.content[0].text;
            console.log('Anthropic Text:', messageContent);

            return messageContent;
        }

        async function generateReport(event) {
            event.preventDefault();
            
            const companyName = document.getElementById('companyName').value;
            const location = document.getElementById('location').value;
            const companyDescriptor = location ? `${companyName} in ${location}` : companyName;
            
            const status = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            status.classList.remove('hidden');
            
            try {
                // Step 1: Generate Perplexity queries
                statusText.textContent = "Querying Perplexity...";

                let completedQueries = 0;
                const totalQueries = PERPLEXITY_QUERIES.length;

                // Create an array of promises for each query
                const queryPromises = PERPLEXITY_QUERIES.map(async (queryTemplate) => {
                    const query = queryTemplate.replace('{company}', companyDescriptor);
                    const result = await queryPerplexity(query);
                    
                    // Update progress after each query completes
                    completedQueries++;
                    statusText.textContent = `Completed ${completedQueries} of ${totalQueries} queries...`;
                    
                    return {
                        query,
                        result
                    };
                });

                // Wait for all queries to complete
                const results = await Promise.all(queryPromises);

                // Combine results in the original order
                const markdown = results
                    .map(({ query, result }) => `# ${query}\n\n${result}\n\n`)
                    .join('');
                
                // Step 2: Generate final report
                statusText.textContent = "Generating final report...";
                const finalReport = await queryAnthropic(markdown);
                
                // Store raw markdown
                const rawMarkdown = document.getElementById('rawMarkdown');
                rawMarkdown.textContent = finalReport;

                // Display rendered markdown
                const markdownOutput = document.getElementById('markdownOutput');
                markdownOutput.innerHTML = marked.parse(finalReport);
                
                document.getElementById('results').classList.remove('hidden');
                status.classList.add('hidden');
                
            } catch (error) {
                statusText.textContent = `Error: ${error.message}`;
                status.classList.remove('bg-yellow-50', 'border-yellow-400');
                status.classList.add('bg-red-50', 'border-red-400');
            }
        }

        function copyToClipboard() {
            const rawMarkdown = document.getElementById('rawMarkdown');
            const markdown = rawMarkdown.textContent;

            navigator.clipboard.writeText(markdown)
                .then(() => alert('Copied to clipboard!'))
                .catch(err => console.error('Failed to copy:', err));
        }

        // Event Listeners
        document.getElementById('researchForm').addEventListener('submit', generateReport);
    </script>
</body>
</html>

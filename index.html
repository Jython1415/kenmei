// File: index.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Research Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <!-- Add crypto-js for basic encryption of API keys in localStorage -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Company Research Tool</h1>
        
        <!-- API Key Configuration -->
        <div id="apiConfig" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">API Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label for="perplexityKey" class="block text-sm font-medium text-gray-700">Perplexity API Key</label>
                    <input type="password" id="perplexityKey" name="perplexityKey"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="anthropicKey" class="block text-sm font-medium text-gray-700">Anthropic API Key</label>
                    <input type="password" id="anthropicKey" name="anthropicKey"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <button onclick="saveAPIKeys()" 
                        class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Save API Keys
                    </button>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <form id="researchForm" class="space-y-4">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700">Company Name</label>
                    <input type="text" id="companyName" name="companyName" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700">Location (Optional)</label>
                    <input type="text" id="location" name="location"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <button type="submit" 
                        class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Generate Report
                    </button>
                </div>
            </form>
        </div>

        <!-- Status Updates -->
        <div id="status" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
            <div class="flex">
                <div class="ml-3">
                    <p class="text-sm text-yellow-700" id="statusText">
                        Processing...
                    </p>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Research Report</h2>
                <div id="markdownOutput" class="prose max-w-none"></div>
                <button onclick="copyToClipboard()" 
                    class="mt-4 inline-flex justify-center rounded-md border border-transparent bg-green-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Copy to Clipboard
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const STORAGE_KEY = 'companyResearchKeys';
        const ENCRYPTION_KEY = 'your-random-encryption-key';
        
        // Update these with your API keys or use the UI to input them
        const DEFAULT_API_KEYS = {
            perplexity: '',
            anthropic: ''
        };

        // Function to save API keys
        function saveAPIKeys() {
            const perplexityKey = document.getElementById('perplexityKey').value;
            const anthropicKey = document.getElementById('anthropicKey').value;
            
            const keys = {
                perplexity: perplexityKey,
                anthropic: anthropicKey
            };
            
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(keys), ENCRYPTION_KEY).toString();
            localStorage.setItem(STORAGE_KEY, encrypted);
            
            console.log('API keys saved successfully!');
            alert('API keys saved successfully!');

        // Load API keys on startup
        window.onload = function() {
            const savedKeys = loadAPIKeys();
            if (savedKeys) {
                document.getElementById('perplexityKey').value = savedKeys.perplexity || '';
                document.getElementById('anthropicKey').value = savedKeys.anthropic || '';
            }
        };

        // Save API keys to localStorage with basic encryption
        function saveAPIKeys() {
            const perplexityKey = document.getElementById('perplexityKey').value;
            const anthropicKey = document.getElementById('anthropicKey').value;
            
            const keys = {
                perplexity: perplexityKey,
                anthropic: anthropicKey
            };
            
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(keys), ENCRYPTION_KEY).toString();
            localStorage.setItem(STORAGE_KEY, encrypted);
            
            alert('API keys saved successfully!');
        }

        // Load API keys from localStorage
        function loadAPIKeys() {
            const encrypted = localStorage.getItem(STORAGE_KEY);
            if (!encrypted) return null;
            
            try {
                const decrypted = CryptoJS.AES.decrypt(encrypted, ENCRYPTION_KEY).toString(CryptoJS.enc.Utf8);
                return JSON.parse(decrypted);
            } catch (error) {
                console.error('Error loading API keys:', error);
                return null;
            }
        }

        // Perplexity API queries
        const PERPLEXITY_QUERIES = [
            "what is {company}",
            "{company}: recent news",
            "{company}: product, business model",
            "{company}: industry position, financials",
            "{company}: history, recent achievements",
            "{company}: mission, values",
            "{company}: culture, workplace environment",
            "{company}: culture, workplace environment; as reported by current employees",
            "What does it take to succeed at {company}?"
        ];

        async function queryPerplexity(query) {
            console.log('Starting Perplexity query:', query);
            
            const keys = loadAPIKeys();
            if (!keys?.perplexity) {
                throw new Error('Perplexity API key not found');
            }

            const response = await fetch('https://api.perplexity.ai/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${keys.perplexity}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'sonar',
                    messages: [
                        { 
                            role: 'system',
                            content: 'Be precise and concise.'
                        },
                        { 
                            role: 'user',
                            content: query 
                        }
                    ],
                    temperature: 0.2,
                    top_p: 0.9,
                    max_tokens: 1024,
                    return_images: false,
                    return_related_questions: false,
                    stream: false,
                    presence_penalty: 0,
                    frequency_penalty: 1
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Perplexity API error: ${response.status} - ${JSON.stringify(errorData)}`);
            }

            const data = await response.json();
            return data.content[0].text;
        }

        async function generateOpenAIReport(markdown) {
            const keys = loadAPIKeys();
            if (!keys?.anthropic) {
                throw new Error('Anthropic API key not found');
            }

            const requestBody = {
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 8192,
                temperature: 1,
                messages: [
                    {
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: `Produce a report based on the following information. Format in markdown with headers and lists. The purpose is to provide context for future conversations about preparing job application materials.\n\n${markdown}`
                            }
                        ]
                    }
                ]
            };
            
            console.log('Anthropic API Request:', {
                url: 'https://api.anthropic.com/v1/messages',
                headers: {
                    'anthropic-version': '2023-06-01',
                    'x-api-key': 'REDACTED',
                    'Content-Type': 'application/json'
                },
                body: requestBody
            });

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'anthropic-version': '2023-06-01',
                    'x-api-key': keys.anthropic,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            const anthropicData = await response.json();
            console.log('Anthropic API Response:', anthropicData);

            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status}`);
            }

            const data = await response.json();
            return perplexityData.choices[0].message.content;
        }

        async function generateReport(event) {
            event.preventDefault();
            
            const companyName = document.getElementById('companyName').value;
            const location = document.getElementById('location').value;
            const companyDescriptor = location ? `${companyName} in ${location}` : companyName;
            
            const status = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            status.classList.remove('hidden');
            
            try {
                // Step 1: Generate Perplexity queries
                statusText.textContent = "Querying Perplexity...";
                let markdown = "";
                
                for (let i = 0; i < PERPLEXITY_QUERIES.length; i++) {
                    const query = PERPLEXITY_QUERIES[i].replace('{company}', companyDescriptor);
                    statusText.textContent = `Processing query ${i + 1} of ${PERPLEXITY_QUERIES.length}...`;
                    
                    const result = await queryPerplexity(query);
                    markdown += `# ${query}\n\n${result}\n\n`;
                }
                
                // Step 2: Generate final report using OpenAI
                statusText.textContent = "Generating final report...";
                const finalReport = await generateOpenAIReport(markdown);
                
                // Display results with markdown formatting
                const markdownOutput = document.getElementById('markdownOutput');
                markdownOutput.innerHTML = marked.parse(finalReport);
                document.getElementById('results').classList.remove('hidden');
                status.classList.add('hidden');
                
            } catch (error) {
                statusText.textContent = `Error: ${error.message}`;
                status.classList.remove('bg-yellow-50', 'border-yellow-400');
                status.classList.add('bg-red-50', 'border-red-400');
            }
        }

        function copyToClipboard() {
            const markdownOutput = document.getElementById('markdownOutput');
            const markdown = markdownOutput.innerText;
            navigator.clipboard.writeText(markdown)
                .then(() => alert('Copied to clipboard!'))
                .catch(err => console.error('Failed to copy:', err));
        }

        // Event Listeners
        document.getElementById('researchForm').addEventListener('submit', generateReport);
    </script>
</body>
</html>
